# OpenCode Web + TUI compose stack
#
# The helper script starts the web server detached, then runs the TUI
# interactively. Exiting the TUI triggers a cleanup that tears down the stack.
#
# Usage: use the 'opencode' helper script from any directory.
# Direct: PROJECT_DIR=/path/to/project docker compose -f compose.yaml up -d --wait opencode-web
#         docker compose -f compose.yaml run --rm opencode-tui

x-common: &common
  image: open-code
  volumes:
    - ${PROJECT_DIR:-.}:/app:rw
    - opencode-config:/home/node/.opencode
  environment:
    - XDG_CONFIG_HOME=/home/node/.opencode/config
    - XDG_STATE_HOME=/home/node/.opencode/state
    - XDG_DATA_HOME=/home/node/.opencode/data
  extra_hosts:
    - "host.docker.internal:host-gateway"

services:
  # Ensures volume subdirectories exist with correct ownership on first run
  opencode-init:
    image: open-code
    user: root
    command: >
      sh -c "mkdir -p /home/node/.opencode/config /home/node/.opencode/state /home/node/.opencode/data &&
             chown node:node /home/node/.opencode /home/node/.opencode/config /home/node/.opencode/state /home/node/.opencode/data"
    volumes:
      - opencode-config:/home/node/.opencode

  opencode-web:
    <<: *common
    command: ["opencode", "web", "--port", "${OPENCODE_PORT:-4096}", "--hostname", "0.0.0.0"]
    ports:
      - "${OPENCODE_PORT:-4096}:${OPENCODE_PORT:-4096}"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${OPENCODE_PORT:-4096}"]
      interval: 2s
      timeout: 3s
      retries: 15
      start_period: 5s
    restart: "no"
    depends_on:
      opencode-init:
        condition: service_completed_successfully

  opencode-tui:
    <<: *common
    command: ["opencode", "attach", "http://opencode-web:${OPENCODE_PORT:-4096}"]
    stdin_open: true
    tty: true
    depends_on:
      opencode-web:
        condition: service_healthy
    restart: "no"

volumes:
  opencode-config:
    external: true
